{% extends "base.html" %}
{% block content %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA==" crossorigin="anonymous"></script>
<script src="{{ url_for('static', filename='js/socketio.js') }}"></script>

<script type="text/javascript" charset="utf-8">

// Variables
var context_menu_class_name = "note_edit_menu_link",
context_menu_prefix = "note_edit_menu_",
context_menu_name = "note_edit_menu",
edit_form_class_name = "edit_form",
edit_form_prefix = "edit_form_",
edit_form_text_prefix = "form_text_",
edit_form_private_prefix = "change_private_",
edit_form_in_character_prefix = "make_in_character_",
hidden_class_name = "hidden",
active_class_name = "--active",
inner_id_prefix = "inner_",
image_class_name = "note_edit_button",
menu_deployed = false;


// Helper functions
function init () {
    click_listener();
}

function edit_note_func(id_num) {
    // send data to server
    let form = document.getElementById(edit_form_prefix + id_num);
    console.log("edit_note_func form", form);
    let note_text = document.getElementById(edit_form_text_prefix + id_num).value,
    note_private = document.getElementById(edit_form_private_prefix + id_num).value,
    note_in_character = document.getElementById(edit_form_in_character_prefix + id_num).value,
    user_id = {{current_user.id}},
    game_id = {{id}};
    console.log("edit_note_func submit values", "text: ", note_text, "private: ", note_private, "in_character: ", note_in_character, "user_id: ", user_id, "game_id: ", game_id);
    socket.emit("edit_note", note_text, note_private, note_in_character, game_id, user_id, id_num);

    // removal of form logic
    console.log("edit_note_func", id_num);
    toggle_form_off(id_num);
    let note = document.getElementById(inner_id_prefix + id_num);
    console.log("edit_note_func", note);
    note.classList.remove(hidden_class_name);
    let img = document.getElementById(id_num);
    img.classList.remove(hidden_class_name);
    return false;
};

function click_inside_element( e, className ) {
  var el = e.srcElement || e.target;
  
  if ( el.classList.contains(className) ) {
    return el;
  } else {
    while ( el = el.parentNode ) {
      if ( el.classList && el.classList.contains(className) ) {
        return el;
      }
    }
  }
  return false;
}

function toggle_menu_off() {
    actives = document.getElementsByClassName(active_class_name)
    for (let i = 0; i < actives.length; i++) {
        actives[i].classList.add(hidden_class_name);
        actives[i].classList.remove(active_class_name);
        menu_deployed = false;
    }
}

function toggle_menu_on(element) {
    if (element.classList.contains(active_class_name)) {} else {
        element.classList.add(active_class_name);
        element.classList.remove(hidden_class_name);
        menu_deployed = true;
    }
}

function find_id(string) {
    var id = "";
    for (let i = 0; i < string.length; i++) {
        if (parseInt(string[i])) {
            id += string[i];
        }
    }
    return id;
}

function toggle_form_on(id_num) {
    
    console.log("toggle_form_on", (inner_id_prefix + id_num));
    let note_text = document.getElementById(inner_id_prefix + id_num);
    console.log("toggle_form_on", note_text);
    note_text.classList.add(hidden_class_name);
    let form = document.getElementById(edit_form_prefix + id_num);
    form.classList.remove(hidden_class_name);
    let img = document.getElementById(id_num);
    img.classList.add(hidden_class_name);
    let text_area = document.getElementById("form_text_" + id_num);
    text_area.select();
}

function toggle_form_off(id_num) {
    let form = document.getElementById(edit_form_prefix + id_num);
    form.classList.add(hidden_class_name);
}

// Core functions
function click_listener() {
    document.addEventListener("click", function(e) {
        if (click_inside_element( e, image_class_name )) {
            if (menu_deployed == false) {
                let context_menu_element = document.getElementById(context_menu_prefix + e.target.id);
                toggle_menu_on(context_menu_element);
            } 
        } else if (click_inside_element( e, context_menu_name )) {
            if (click_inside_element( e, context_menu_class_name )) {
                if ( e.target.getAttribute("data-action") == "edit" ) {
                    toggle_menu_off();
                    let id_num = find_id(e.target.id);
                    toggle_form_on(id_num);
                } else {
                    console.log("click_listener delete" )
                }
        }

        } else {
            toggle_menu_off();
        }
    })
}


    document.addEventListener("DOMContentLoaded", function() { 
        let forms = document.getElementsByClassName(edit_form_class_name);
        for (let i = 0; i < forms.length; i++) {
            let id_num = find_id(forms[i].id);
            forms[i].addEventListener("submit", function () {
                edit_note_func(id_num)
            })
        }
        init();
    });

</script>

<form id="note_form">
    <input type="hidden" id='note_user_id' name='note_user_id' value='{{current_user.id}}'>
    <input type="hidden" id='note_game_id' name='note_game_id' value='{{id}}'>
    <label for='note_note'>Note:</label>
    <textarea id='note_note' required autocomplete='off' type='textarea' placeholder='Collaborative note'></textarea>
    <br/>
    <label for='note_private'>Note is private(The GM will still be able to see it):</label>
    <input type='checkbox' class="note_checkbox" id='note_private' name='note_private' value='False'>
    <br/>
    <label for='note_in_character'>Note is written in character:</label>
    <input type='checkbox' class="note_checkbox" id='note_in_character' name='note_in_character' value='False'><br/>
    <input id='note_submit' type='submit' value='Submit' name='note_submit'>

</form>
<br/>
<br/>
{% if dmid == current_user.id %}
    
    <button id='new_session_button'>Start a new session?</button>
    <div id='new_session_form_div'></div>
{% endif %}

<div id="Session Cards">
{% if session_titles %}


    <!-- Session Title Cards -->
    {% for session in session_titles %}
        <div class="sessions border shadow-lg p-3 mb-5 bg-light rounded" id="session_header_{{session.id}}">
            <h2>Session {{session.number}}: {{session.title}}</h2>
            <div id="session_card_{{session.number}}">


                <!-- Session Notes -->
                <!-- Logic for if there is more than one session -->
                {% if typ(note_dict[session.number]) == lis %}
                    <ul>
                        {% for note in note_dict[session.number] %}
                            <li class="span_cont">
                                <span class="span_cont" id='note_{{note.id}}'>
                                    {{ note.date_added }} || <b>{{ note.charname }}:</b> 
                                    <span class="note_text" id='inner_{{note.id}}'>  
                                        {{ note.note }}
                                    </span>
                                    {% if note.user_id == current_user.id %}


                                    <!-- Edit Button -->
                                    <a id='edit_{{note.id}}' >
                                        <img id='{{note.id}}' class='note_edit_button' src={{edit_img}}>
                                    </a>
                                    <form class='hidden edit_form' id="edit_form_{{ note.id }}">
                                        <input type='text' id="form_text_{{note.id}}" value='{{ note.note }}'>
                                        <input type='submit' value='submit'>
                                        </br>

                                        <span class="checkbox_span">
                                            <input type='checkbox' class="note_checkbox" id='change_private_{{note.id}}' value='{{ note.private }}'>
                                            <label for='change_private_{{note.id}}'>
                                                Make Private?
                                            </label>
                                        </span>
                                        <span class="checkbox_span">
                                        <input type='checkbox' class="note_checkbox" id='make_in_character_{{note.id}}' value='{{ note.in_character }}'>
                                        <label for='make_in_character_{{note.id}}'>
                                            Change to <i>in character?</i>
                                        </label>
                                        </span>
                                        
                                    </form>
                                </span>





                                <!-- Edit Note Menu -->
                                <nav id="note_edit_menu_{{note.id}}" class="note_edit_menu hidden">
                                    <ul class="note_edit_menu_items">
                                        <li class="note_edit_menu_item">
                                            <a href="#" id="note_edit_menu_edit_{{note.id}}" class="note_edit_menu_link" data-action="edit">
                                                Edit Note
                                            </a>
                                        </li>
                                        <li class="note_edit_menu_item">
                                            <a href="#" id="note_edit_menu_delete_{{note.id}}" class="note_edit_menu_link" data-action="delete">
                                                Delete Note
                                            </a>
                                        </li>
                                    </ul>
                                </nav>
                                {% endif %}
                            </li>
                            </br>

                        {% endfor %}
                    </ul>
                
                <!-- Logic for if there is only one Session -->
                {% else %}
                    <ul>
                        <li class="span_cont">
                            <span class="spane_cont" id='note_{{note_dict[session.number].id}}'>
                                {{ note_dict[session.number].date_added }} || <b>{{ note_dict[session.number].charname }}:</b> 
                                <span class="note_text" id='inner_{{note.id}}'>  
                                    {{ note_dict[session.number].note }}
                                </span>
                                {% if note.user_id == current_user.id %}
                                <!-- Edit Button -->
                                <a id='edit_note_{{note_dict[session.number].id}}' >
                                    <img id='{{note_dict[session.number].id}}' class='note_edit_button exclude' src={{edit_img}}>
                                </a>
                                <form class='hidden edit_form' id="edit_form_{{ note_dict[session.number].id }}">
                                    <input type='text' id="form_text_{{note_dict[session.number].id}}" value='{{ note_dict[session.number].note }}'>
                                    <input type='submit' value='submit'>
                                    </br>
                                    <span class="checkbox_span"></span>
                                        <input type='checkbox' class="note_checkbox" id='change_private_{{note_dict[session.number].id}}' value='{{ note_dict[session.number].private }}'>
                                        <label for='change_private_{{note_dict[session.number].id}}'>
                                            Make Private?
                                        </label>
                                    </span>

                                    <span class="checkbox_span">
                                    <input type='checkbox' class="note_checkbox" id='make_in_character_{{note_dict[session.number].id}}' value='{{ note_dict[session.number].in_character }}'>
                                    <label for='make_in_character_{{note_dict[session.number]}}'>
                                        Change to <i>in character?</i>
                                    </label>
                                    </span>
                                    
                                </form>
                            </span>

                            <!-- Edit Note Menu -->
                            <nav id="note_edit_menu_{{note_dict[session.number].id}}" class="note_edit_menu hidden">
                                <ul class="note_edit_menu_items">
                                    <li class="note_edit_menu_item">
                                        <a href="#" id="note_edit_menu_edit_{{note_dict[session.number].id}}" class="note_edit_menu_link" data-action="edit">
                                            Edit Note
                                        </a>
                                    </li>
                                    <li class="note_edit_menu_item">
                                        <a href="#" id="note_edit_menu_delete_{{note_dict[session.number].id}}" class="note_edit_menu_link" data-action="delete">
                                            Delete Note
                                        </a>
                                    </li>
                                </ul>
                            </nav>
                        {% endif %}
                        </li>
                        </br>
                    </ul>


                {% endif %}
            </div>
        </div>
    {% endfor %}
{% endif %}
</div>
{% endblock %}