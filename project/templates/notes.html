{% extends "base.html" %}
{% block content %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA==" crossorigin="anonymous"></script>
<!-- <script src="{{ url_for('static', filename='js/notes.js') }}"></script> -->
<script type="text/javascript" charset="utf-8">

// Core variables
const socket = io();
var user_id = {{current_user.id}}
, game_id = {{id}};

// Variables
var context_menu_class_name = "note_edit_menu_link"
, context_menu_prefix = "note_edit_menu_"
, context_menu_name = "note_edit_menu"

, edit_form_class_name = "edit_form"
, edit_form_prefix = "edit_form_"
, edit_form_text_prefix = "form_text_"
, edit_form_private_prefix = "change_private_"

, className__hidden = "hidden"
, active_class_name = "active"
, inner_id_prefix = "inner_"
, image_class_name = "note_edit_button"
, new_session_form_game_id = "new_session_form_game_id"
, menu_deployed = false

, flag__formNewSession_container = "div[data-flag='formNewSession_container']"
, flag__button_newSessionDisplay = "button[data-flag='button_newSessionDisplay']"
, flag__formNewSession_form = "form[data-flag='formNewSession_form']"
, flag__formNewSession_inputSessionNumber = "input[data-flag='formNewSession_inputSessionNumber']"
, flag__formNewSession_inputSessionTitle = "input[data-flag='formNewSession_inputSessionTitle']"
, flag__formNewSession_inputSessionSynopsis = "input[data-flag='formNewSession_inputSessionSynopsis"
, flag__formNewSession_buttonCancel = "input[data-flag='formNewSession_buttonCancel']"
, flag__formNewSession_idGame = "input[data-flag='formNewSession_idGame']"
, flag__newQuill_formSession = "form[data-flag='newQuill_FormSession']"


, element__newQuill_formSession = document.querySelector(flag__newQuill_formSession);




// socket.on Functions
// 
// 
// 
// //
socket.on('fill_new_session', function(new_card) {
    // insert new session card into document
    // 
    // Local Variables
    let flag__sessionContainer = "div[data-flag='sessionsContainer"
    , element__sessionsContainer = document.querySelector(flag__sessionContainer);

    // Insert
    element__sessionsContainer.insertAdjacentHTML('beforeend', new_card)
});


// display new note
socket.on('fill_new_note', function(new_note, priv, session_number) {
    this_session = document.getElementById('note_list_' + session_number)
    this_session.insertAdjacentHTML('beforeend', new_note)
});

// display note edit
socket.on('fill_note_edit', function(editted_note, is_private, session_number, note_id) {
    note_location = document.getElementById("inner_" + note_id);
    note_location.innerHTML = editted_note;
});

// Remove deleted note for all users
socket.on('remove_deleted_note', function(id_num) {
    let el_to_remove = document.getElementById("note_line_" + id_num)
    el_to_remove.remove();
})




// Helper functions
//
//
//
//


function edit_note_func(id_num) {
    // send data to server
    // 

    // local variables
    let flag__notes_noteText = "span[data-id_noteText='"+id_num+"']"
    , flag__formEdit_form = "form[data-id_formEdit='"+id_num+"']"
    , flag__formEdit_private = "input[data-id_noteCheckboxPrivate='"+id_num+"']"
    , flag__notes_editImage = "span[data-id_editImage='"+id_num+"']"


    // let form = document.getElementById(edit_form_prefix + id_num)
    , element__formEdit_form = document.querySelector(flag__formEdit_form)

    , element__notes_editImage = document.querySelector(flag__notes_editImage)

    // , note_text = document.getElementById(edit_form_text_prefix + id_num).value,
    , element__notes_noteText = document.querySelector(flag__notes_noteText)
    , note_text = element__notes_noteText.innerHTML

    // note_private = document.getElementById(edit_form_private_prefix + id_num).value,
    , element__notes_checkboxPrivate = document.querySelector(flag__formEdit_private)
    , note_private = element__notes_checkboxPrivate.value;

    socket.emit("edit_note", note_text, note_private, game_id, user_id, id_num);

    // removal of form logic
    toggle_form_off(id_num);
    // let note = document.getElementById(inner_id_prefix + id_num);
    element__notes_noteText.classList.remove(className__hidden);
    // let img = document.getElementById(id_num);
    element__notes_editImage.classList.remove(className__hidden);
    return false;
};



// Checkboxes
// 
//
function set_true_checkboxes_to_checked() {
    // find all checkboxes
    let checkboxes = document.querySelectorAll("input[type='checkbox']");
    
    // make a list of the checkboxes that have a value of "True"
    let checkboxes__true = [];
    for (let i = 0; i < checkboxes.length; i++) {
        if (checkboxes[i].value == "True") {
            checkboxes__true.push(checkboxes[i])
        }
    }


    // Set Checkboxes with a value of "True" to checked
    for (let i = 0; i < checkboxes__true.length; i++) {
        checkboxes__true[i].checked = true;
    }
}
function change_checkbox_value_onClick() {
    // find all checkboxes
    let checkboxes = document.querySelectorAll("input[type='checkbox']");

    // set click events
    for (let i = 0; i < checkboxes.length; i++) {
        checkboxes[i].addEventListener("click", function(event) {
            // find event origin
            let clicked = event.target;

            // change value to opposite of current
            if (clicked.value == "True") {
                clicked.value = "False";
            } else {
                clicked.value = "True";
            }
        })
    }
}
function apply_checkbox_value_logic() {
    // run subprograms
    set_true_checkboxes_to_checked();
    change_checkbox_value_onClick();
}
// // // // //


// Contextual menu functions
// 
// 
// //

// check if relevant element wasa clicked
function click_inside_element( e, className ) {
  let el = e.target;

  if ( el.classList.contains(className) ) {
    return el;
  } else {
    while ( el = el.parentNode ) {
      if ( el.classList && el.classList.contains(className) ) {
        return el;
      }
    }
  }
  return false;
}

// Set click events
function click_listener() {
    document.addEventListener("click", function(e) {
        if (click_inside_element( e, image_class_name )) {
            if (menu_deployed == false) {
                // let context_menu_element = document.getElementById(context_menu_prefix + e.target.id);
                let flag__contextMenu = "div[data-contextMenuId='"+e.target.getAttribute("data-id_editImage")+"']"
                , element__contextMenu = document.querySelector(flag__contextMenu);
                toggle_menu_on(element__contextMenu);
            } 
        } else if (click_inside_element( e, context_menu_name )) {
            if (click_inside_element( e, context_menu_class_name )) {
                if ( e.target.getAttribute("data-action") == "edit" ) {
                    toggle_menu_off();

                    let id_num = e.target.getAttribute("data-id_note");

                    toggle_form_on(id_num);
                } else {
                    let id_num = e.target.getAttribute("data-id_note");
                    socket.emit("delete_note", id_num)
                }
            }
        } else {
            toggle_menu_off();
        }
    })
}



function toggle_menu_off() {
    actives = document.getElementsByClassName(active_class_name)
    for (let i = 0; i < actives.length; i++) {
        actives[i].classList.add(className__hidden);
        actives[i].classList.remove(active_class_name);
        menu_deployed = false;
    }
}

function toggle_menu_on(element) {

    if (element.classList.contains(active_class_name)) {} else {
        element.classList.add(active_class_name);
        element.classList.remove(className__hidden);
        menu_deployed = true;
    }
}

function toggle_form_on(id_num) {
    // Local variables
    let flag__formEdit = "form[data-id_formEdit='"+id_num+"']"
    , flag__notes_noteText = "span[data-id_noteText='"+id_num+"']"
    , flag__notes_editImage = "span[data-id_editImage='"+id_num+"']"
    , flag__formEdit_textArea = "input[data-id_formText='"+id_num+"']"

    , element__formEdit = document.querySelector(flag__formEdit)
    , element__notes_noteText = document.querySelector(flag__notes_noteText)
    , element__notes_editImage = document.querySelector(flag__notes_editImage)
    , element__formEdit_textArea = document.querySelector(flag__formEdit_textArea);


    // hide original note
    element__notes_noteText.classList.add(className__hidden);
    element__notes_editImage.classList.add(className__hidden);

    // display edit form
    element__formEdit.classList.remove(className__hidden);

    // highlight text to edit
    element__formEdit_textArea.select();
}

function toggle_form_off(id_num) {
    let flag__formEdit = "form[data-id_formEdit='"+id_num+"']" 
    , LForm_element = document.querySelector(flag__formEdit)
    LForm_element.classList.add(className__hidden);
}
// Start app
function init() {
        click_listener();
        apply_checkbox_value_logic();
    }

js_dict = JSON.parse({{js_note_dict|tojson }})

document.addEventListener("DOMContentLoaded", function() {


    // set new notes to populate after page load. 
    // We do it this because wysiwig fomatting doesn't work otherwise
    // variables
    let note_session = 0
    , note_id_index = 0
    , index__noteText = 1
    , index__noteId = 0;

    {% for session in session_titles %}
    // set the current session in the loop
    if (note_session == {{session.number}}) {} else { note_session = {{session.number}} }
    // loop through each session's notes and place in the correct location
    for (let i = 0; i < js_dict[note_session].length; i++) {
        let id__note = ( js_dict[note_session][i][index__noteId])
        , note_note = js_dict[note_session][i][index__noteText]
        , flag__notes_noteText = "span[data-id_noteText='"+id__note+"']"
        , element__notes_noteText = document.querySelector(flag__notes_noteText);
        element__notes_noteText.innerHTML = note_note;
    }
    {% endfor %}

    


    {% if current_user.id == dm_id %}
    // New Session form functions:
    // variables
    let element__formNewSession_container = document.querySelector(flag__formNewSession_container)
    , element__button_newSessionDisplay = document.querySelector(flag__button_newSessionDisplay)
    , element__formNewSession_buttonCancel = document.querySelector(flag__formNewSession_buttonCancel)
    , element__formNewSession_form = document.querySelector(flag__formNewSession_form)
    , element__formNewSession_idGame = document.querySelector(flag__formNewSession_idGame)
    , element__formNewSession_inputNumber = document.querySelector(flag__formNewSession_inputSessionNumber)
    , element__formNewSession_inputTitle = document.querySelector(flag__formNewSession_inputSessionTitle)
    , element__formNewSession_inputSynopsis = document.querySelector(flag__formNewSession_inputSessionSynopsis);

    
    element__button_newSessionDisplay.onclick = function() {
    // display form for making new session card
        element__formNewSession_container.classList.remove(className__hidden);
        element__button_newSessionDisplay.classList.add(className__hidden);
    }


    var cancel_new_session_func = function () {
    // function to remove new session form and add the edit button back
        element__formNewSession_container.classList.add(className__hidden);
        element__button_newSessionDisplay.classList.remove(className__hidden);
    }
    // remove form if cancel button is clicked
    element__formNewSession_buttonCancel.onclick = function() {
        cancel_new_session_func();
    } 
    function new_session_form_is_incomplete() {
        // check each field to see if it's empty

        // Session Title
        if ( element__formNewSession_inputTitle.value == '' || element__formNewSession_inputTitle.value == null ) {
            return true;
        // check to make sure the number isn't zero which will mess up the rest of the algo's logic
        } else if ( element__formNewSession_inputNumber.value == 0 ) {
            // skip child conditionals if session zero
        } else {
            // Session Number
            if ( element__formNewSession_inputNumber.value == '' || element__formNewSession_inputNumber.value == null ) {
                return true;
            // Check if the number field contains an integer
            } else if ( parseInt( element__formNewSession_inputNumber.value ) == '' || parseInt( element__formNewSession_inputNumber.value ) == null ) {
                return true;
            } 
        }
        return false;
    }
    function new_session_form_is_not_unique() {
        // check to make sure the session doesn't already exist
        if ( document.querySelector( "ul[data-idSession='"+element__formNewSession_inputNumber.value+"']" ) ) {
            return true;
        } else {
            return false;
        }
    }
   
    element__formNewSession_form.addEventListener( "submit", function( event ) {
         // capture and send new session to server
        
        event.preventDefault();

        // ensure that form is filled out correctly
        if ( new_session_form_is_incomplete() ) { 
            alert("Must fill out required fields");
            return false;
        } else if ( new_session_form_is_not_unique() ) {
            alert("Session number must be unique");
            return false;
        } else {

        // send new session data to server through socket.io
            socket.emit('send_new_session', game_id, element__formNewSession_inputNumber.value, element__formNewSession_inputTitle.value, element__formNewSession_inputSynopsis.value);
            
            // remove new session form
            cancel_new_session_func();
            return false;
        }
    })
    {% endif %}

    // New Note form functions:
    // Variables
    // let new_note_form = document.getElementById(new_note_form_id)
    var element__newQuill_formSession = document.querySelector(flag__newQuill_formSession)
    flag__newQuillPrivate = "input[data-flag='newQuillPrivate']"
    , element__newQuill_private = document.querySelector(flag__newQuillPrivate);
    // , new_note_form_private = document.getElementById('note_private');


    // capture and send new note to server
    element__newQuill_formSession.addEventListener("submit", function(event) {
        event.preventDefault();
        let new_note_html = quill.root.innerHTML
        , new_note_private = element__newQuill_private.value

        if (quill.getText() == '\n') {
            alert("note cannot be empty");
            return false
        } else {
            socket.emit('send_new_note'
                , user_id
                , game_id
                , new_note_html
                , new_note_private
            )
            return false
        }
    });


    // let forms = document.getElementsByClassName(edit_form_class_name);

    let flag__formEdit_form = "form[data-flag='formEdit']"
    , elements__formEdit_form = document.querySelectorAll(flag__formEdit_form);

    for (let i = 0; i < elements__formEdit_form.length; i++) {
        elements__formEdit_form[i].addEventListener("submit", function (event) {
            event.preventDefault();
            let id_num = event.target.getAttribute("data-id_formEdit")
            edit_note_func(id_num);
        })
    }





    init();
})

</script>


<div class="game-container">
    <div class="container">
        <h1>{{ game_name }}</h1>
        {% if dm_id == current_user.id %}
            <div class="new-session">
                <button class="button primary" data-flag="button_newSessionDisplay">Start a new session?</button>
            </div>
        {% endif %}
        <div class="notes-container">
            <div class="session-log">
                <h2>Session Log</h2>

                <ul class="sessions-list">
                    <li class="session-anchor current">
                        <h4>Session 2</h4>
                        <h2>Into the Woods</h2>
                    </li>
                    <li class="session-anchor">
                        <h4>Session 1</h4>
                        <h2>The Thick Plottens</h2>
                    </li>
                    <li class="session-anchor">
                        <h4>Session 0</h4>
                        <h2>We are All Well Met</h2>
                    </li>
                </ul>
            </div>
            <div class="notes">
                <h2>Add a new note to this session.</h2>
                <div class="comment-container">
                    <form class="wysiwyg-form" data-flag="newQuill_FormSession" id="test_form_quill">
                        <div class="form-group">
                        
                        <input name="about" type="hidden" style="z-index: 101;">
                        <input type="hidden" id='note_user_id' name='note_user_id' value='{{current_user.id}}'>
                        <input type="hidden" id='note_game_id' name='note_game_id' value='{{id}}'>
                        <div id="editor">
                        </div>
                        </div>
                        <div class="form-group">
                            <div class="row checkbox">
                                <input type='checkbox' class="note_checkbox" data-flag="newQuillPrivate" name='note_private' value='False'>
                                <label for='note_private'>Private - Visible only to you and the DM.</label>
                            </div>
                            <div class="row button-row">
                                <button class="button primary" type="submit">Submit</button>
                            </div>
                        </div>
                        
                    </form>
                </div>
                <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
                <script>
                    var quill = new Quill('#editor', { 
                    modules: {
                        toolbar: [
                        ['bold', 'italic'],
                        [{ 'size': ['small', false, 'large', 'huge'] }],
                        [{ list: 'ordered' }, { list: 'bullet' }]
                        ]
                    },
                    placeholder: 'A note about this session.',
                    theme: 'snow'
                    });
                </script>
                <div class="sessions-scroll-container" data-flag="sessionsContainer" id="Session Cards">
                    {% if session_titles %}
                        <!-- Session Title Cards -->
                        {% for session in session_titles %}
                            <div class="session-container" id="session_header_{{session.id}}">
                                <h2>Session {{session.number}}: {{session.title}}</h2>
                                <div id="session_card_{{session.number}}">
                                    <!-- Session Notes -->
                                    <!-- Logic for if there is more than one session -->
                                    
                                    <ul class="note_list" data-idSession="{{session.number}}" id="note_list_{{session.number}}">
                                        {% for note in note_dict[session.number] %}
                                        <li class="span_cont" id="note_line_{{note.id}}">
                                            <span class="span_cont note-item" id='note_{{note.id}}'>
                                                <span class="note-author">
                                                    <div class="author-image" style="background-image: url(../static/images/default_dm.jpg)"></div>
                                                    <!-- {{ note.date_added }} || -->
                                                </span>

                                                <span class="note-content">
                                                    <h3>{{ note.charname }}:</h3>
                                                    <span class="note-ql" data-id_noteText="{{note.id}}">
                                                    </span>
                                                </span>

                                                {% if note.user_id == current_user.id %}
                                                <!-- Edit Button -->
                                                <a class="edit-note" id='edit_{{note.id}}'>
                                                    <span id='{{note.id}}' data-id_editImage="{{ note.id }}" class='note_edit_button far fa-edit' src={{edit_img}}></span>
                                                </a>
                                                <form class='hidden edit_form' data-flag="formEdit" data-id_formEdit="{{ note.id }}">
                                                    <input type='text' data-id_formText="{{note.id}}" value='{{ note.note }}'>
                                                    <!-- <input type='text' id="form_text_{{note.id}}" value='{{ note.note }}'> -->
                                                    <input type='submit' value='submit'>
                                                    <span class="checkbox_span">
                                                        <input type='checkbox' class="" data-id_noteCheckboxPrivate="{{ note.id }}" value='{{ note.private }}'>
                                                        <label for='change_private_{{note.id}}'>
                                                            Private?
                                                        </label>
                                                    </span>
                                                </form>

                                                <!-- Edit Note Menu -->
                                                <div data-contextMenuId="{{note.id}}" class="note_edit_menu hidden">
                                                    <ul class="note_edit_menu_items">
                                                        <li class="note_edit_menu_item">
                                                            <a href="#" id="note_edit_menu_edit_{{note.id}}" class="note_edit_menu_link button secondary" data-id_note="{{note.id}}" data-action="edit">
                                                                Edit Note
                                                            </a>
                                                        </li>
                                                        <li class="note_edit_menu_item">
                                                            <a href="#" id="note_edit_menu_delete_{{note.id}}" class="note_edit_menu_link button secondary" data-id_note="{{note.id}}" data-action="delete">
                                                                Delete Note
                                                            </a>
                                                        </li>
                                                    </ul>
                                                </div>
                                                {% endif %}

                                            </span>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% if dm_id == current_user.id %}
<!-- New Session Form -->
<div data-flag="formNewSession_container" class="hidden" style="z-index: 100;">
    <!-- <div class="shroud"></div> -->
    <div class="modal-container">
        <div class="modal">
            <div class="content">
                <h2>Session Info</h2>
                <form data-flag="formNewSession_form">
                    <input data-flag="formNewSession_idGame" id='new_session_form_game_id' type='hidden' value='{{id}}'>
                    <input data-flag="formNewSession_inputSessionNumber" required placeholder='Number(Required)' type='number' min='0'>
                    <input data-flag="formNewSession_inputSessionTitle" required placeholder='Title(Required)' type='text'>
                    <input data-flag="formNewSession_inputSessionSynopsis" type='text' placeholder='Optional Synopsis'>
                    <input class="button primary" type='submit' value='Make Session'>
                    <input class="button secondary" type='button' data-flag="formNewSession_buttonCancel" value='Cancel'>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}