{% extends "base.html" %}
{% block content %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA==" crossorigin="anonymous"></script>
<!-- <script src="{{ url_for('static', filename='js/notes.js') }}"></script> -->
<script type="text/javascript" charset="utf-8">

const socket = io();

// Variables
var context_menu_class_name = "note_edit_menu_link"
, context_menu_prefix = "note_edit_menu_"
, context_menu_name = "note_edit_menu"

, edit_form_class_name = "edit_form"
, edit_form_prefix = "edit_form_"
, edit_form_text_prefix = "form_text_"
, edit_form_private_prefix = "change_private_"
, edit_form_in_character_prefix = "make_in_character_"

, hidden_class_name = "hidden"
, active_class_name = "--active"
, inner_id_prefix = "inner_"
, image_class_name = "note_edit_button"
, new_session_form_game_id = "new_session_form_game_id"
, menu_deployed = false

, new_session_form_container_id = "new_session_cont"
, new_session_button_id = "new_session_button"
, new_session_form_id = "new_session_form"
, new_session_form_number_id = "new_session_form_number"
, new_session_form_title_id = "new_session_form_title"
, new_session_form_synopsis_id = "new_session_form_synopsis"
, new_session_form_cancel_id = "cancel_new_session"

, quill_form_id = "test_form_quill"
, new_note_form_id = "test_form_quill"
, form_container_id = "test_form_quill";

var test_form = document.getElementById(quill_form_id)

, form = document.getElementById(form_container_id)
, about = document.querySelector('input[name=about]');
console.log("test_form: ", user_id, game_id, test_form, form, about)



// socket.on Functions
// 
// 
// 
// display new session card
socket.on('fill_new_session', function(new_card) {
    session_cards = document.getElementById('Session Cards_' + number)
    session_cards.insertAdjacentHTML('beforeend', new_card)
});


// display new note
socket.on('fill_new_note', function(new_note, priv, session_number, in_character) {
    this_session = document.getElementById('note_list_' + session_number)
    this_session.insertAdjacentHTML('beforeend', new_note)
});

// display note edit
socket.on('fill_note_edit', function(editted_note, is_private, session_number, in_character, note_id) {
    note_location = document.getElementById("inner_" + note_id);
    note_location.innerHTML = editted_note;
});

// Remove deleted note for all users
socket.on('remove_deleted_note', function(id_num) {
    let el_to_remove = document.getElementById("note_line_" + id_num)
    el_to_remove.remove();
})




// Helper functions
//
//
//
//


function edit_note_func(id_num) {
    // send data to server
    let form = document.getElementById(edit_form_prefix + id_num);
    let note_text = document.getElementById(edit_form_text_prefix + id_num).value,
    note_private = document.getElementById(edit_form_private_prefix + id_num).value,
    note_in_character = "False",
    user_id = {{current_user.id}},
    game_id = {{id}};
    socket.emit("edit_note", note_text, note_private, note_in_character, game_id, user_id, id_num);

    // removal of form logic
    toggle_form_off(id_num);
    let note = document.getElementById(inner_id_prefix + id_num);
    note.classList.remove(hidden_class_name);
    let img = document.getElementById(id_num);
    img.classList.remove(hidden_class_name);
    return false;
};

function click_inside_element( e, className ) {
  var el = e.srcElement || e.target;

  if ( el.classList.contains(className) ) {
    return el;
  } else {
    while ( el = el.parentNode ) {
      if ( el.classList && el.classList.contains(className) ) {
        return el;
      }
    }
  }
  return false;
}

function toggle_menu_off() {
    actives = document.getElementsByClassName(active_class_name)
    for (let i = 0; i < actives.length; i++) {
        actives[i].classList.add(hidden_class_name);
        actives[i].classList.remove(active_class_name);
        menu_deployed = false;
    }
}

function toggle_menu_on(element) {
    if (element.classList.contains(active_class_name)) {} else {
        element.classList.add(active_class_name);
        element.classList.remove(hidden_class_name);
        menu_deployed = true;
    }
}

function find_id(string) {
    var id = "";
    for (let i = 0; i < string.length; i++) {
        if (parseInt(string[i])) {
            id += string[i];
        }
    }
    return id;
}

function toggle_form_on(id_num) {

    let note_text = document.getElementById(inner_id_prefix + id_num);
    note_text.classList.add(hidden_class_name);
    let form = document.getElementById(edit_form_prefix + id_num);
    form.classList.remove(hidden_class_name);
    let img = document.getElementById(id_num);
    img.classList.add(hidden_class_name);
    let text_area = document.getElementById("form_text_" + id_num);
    text_area.select();
}

function toggle_form_off(id_num) {
    let form = document.getElementById(edit_form_prefix + id_num);
    form.classList.add(hidden_class_name);
}


// Checkboxes
// 
//
function set_true_checkboxes_to_checked() {
    // find all checkboxes
    let checkboxes = document.querySelectorAll("input[type='checkbox']");
    
    // make a list of the checkboxes that have a value of "True"
    let checkboxes__true = [];
    for (let i = 0; i < checkboxes.length; i++) {
        if (checkboxes[i].value == "True") {
            checkboxes__true.push(checkboxes[i])
        }
    }


    // Set Checkboxes with a value of "True" to checked
    for (let i = 0; i < checkboxes__true.length; i++) {
        checkboxes__true[i].checked = true;
    }
}

function change_checkbox_value_onClick() {
    // find all checkboxes
    var checkboxes = document.querySelectorAll("input[type='checkbox']");

    // set click events
    for (let i = 0; i < checkboxes.length; i++) {
        console.log("setting", i)
        checkboxes[i].addEventListener("click", function(event) {
            // find event origin
            let clicked = event.target;
            console.log(clicked)

            // change value to opposite of current
            if (clicked.value == "True") {
                clicked.value = "False";
            } else {
                clicked.value = "True";
            }
        })
    }
}

function apply_checkbox_value_logic() {
    set_true_checkboxes_to_checked();
    change_checkbox_value_onClick();
}

document.addEventListener("DOMContentLoaded", function() { 

    apply_checkbox_value_logic();


    {% if current_user.id == dm_id %}
    // New Session form functions:
    // variables
    let form_container = document.getElementById(new_session_form_container_id)
    , new_session_button = document.getElementById(new_session_button_id)
    , cancel_button = document.getElementById(new_session_form_cancel_id)
    , new_session_form = document.getElementById(new_session_form_id)
    , game_id_input_element = document.getElementById(new_session_form_game_id)
    , number_input_element = document.getElementById(new_session_form_number_id)
    , title_input_element = document.getElementById(new_session_form_title_id)
    , synopsis_input_element = document.getElementById(new_session_form_synopsis_id);

    // create form for making new session card
    new_session_button.onclick = function() {
        form_container.classList.remove(hidden_class_name);
        new_session_button.classList.add(hidden_class_name);
    }

    // function to remove new session form and add the button back
    var cancel_new_session_func = function () {
        form_container.classList.add(hidden_class_name);
        new_session_button.classList.remove(hidden_class_name);
    }
    // remove form if cancel button is clicked
    cancel_button.onclick = function() {
        cancel_new_session_func();
    } 

    // capture and send new session to server
    new_session_form.addEventListener("submit", function() {
        // ensure that form is filled out correctly
        console.log("on_submit")
        if (game_id_input_element.value != '' && number_input_element.value != '' && title_input_element.value != '' && parseInt(number_input_element.value) > -1) {
            if (!document.getElementById("session_card_"+number_input_element.value)) {
                socket.emit('send_new_session', game_id_input_element.value, number_input_element.value, title_input_element.value, synopsis_input_element.value);
                cancel_new_session_func();
                return false;
            } else {
                alert("Session number must be unique");
                return false;
            }
        } else {
            alert("Must fill out required fields");
            return false;
        }
    })
    {% endif %}

    // New Note form functions:
    // Variables
    let new_note_form = document.getElementById(new_note_form_id)
    , new_note_form_private = document.getElementById('note_private');


    // capture and send new note to server
    new_note_form.addEventListener("submit", function(event) {
        event.preventDefault();
        let new_note_html = quill.root.innerHTML
        , new_note_private = new_note_form_private.value
        , new_note_in_character = "False";

        if (quill.getText() == '\n') {
            alert("note cannot be empty");
            return false
        } else {
            console.log("note form submit")
            console.log("note form submit", user_id, game_id, new_note_html, new_note_private, new_note_in_character)
            socket.emit('send_new_note'
                , user_id
                , game_id
                , new_note_html
                , new_note_private
                , new_note_in_character
            )
            return false
        }
    });


    let forms = document.getElementsByClassName(edit_form_class_name);
    for (let i = 0; i < forms.length; i++) {
        let id_num = find_id(forms[i].id);
        forms[i].addEventListener("submit", function () {
            edit_note_func(id_num)
        })
    }

    // Core functions
    function click_listener() {
        document.addEventListener("click", function(e) {
            if (click_inside_element( e, image_class_name )) {
                if (menu_deployed == false) {
                    let context_menu_element = document.getElementById(context_menu_prefix + e.target.id);
                    toggle_menu_on(context_menu_element);
                } 
            } else if (click_inside_element( e, context_menu_name )) {
                if (click_inside_element( e, context_menu_class_name )) {
                    if ( e.target.getAttribute("data-action") == "edit" ) {
                        toggle_menu_off();
                        let id_num = find_id(e.target.id);
                        toggle_form_on(id_num);
                    } else {
                        let id_num = find_id(e.target.id);
                        socket.emit("delete_note", id_num)
                    }
                }
            } else {
                toggle_menu_off();
            }
        })
    }

    function init () {
        click_listener();
    }

    init();

})


var user_id={{current_user.id}}
, game_id={{id}};

js_dict = JSON.parse({{js_note_dict|tojson }})
console.log("js_dict", js_dict)

document.addEventListener("DOMContentLoaded", function() {
    // set new notes to populate (doing this because wysiwig fomatting doesn't work otherwise)
    let note_session = 0
    , note_id_index = 0
    , note_note_index = 1;
    {% for session in session_titles %}
    if (note_session == {{session.number}}) {} else { note_session = {{session.number}} }
    for (let i = 0; i < js_dict[note_session].length; i++) {
        let note_id = (inner_id_prefix + js_dict[note_session][i][note_id_index])
        , note_note = js_dict[note_session][i][note_note_index]
        , note_element = document.getElementById(note_id);
        note_element.innerHTML = note_note
    }
    {% endfor %}

    // New Session form functions:
    // variables
    let form_container = document.getElementById(new_session_form_container_id)
    , new_session_button = document.getElementById(new_session_button_id)
    , cancel_button = document.getElementById(new_session_form_cancel_id)
    , new_session_form = document.getElementById(new_session_form_id)
    , game_id_input_element = document.getElementById(new_session_form_game_id)
    , number_input_element = document.getElementById(new_session_form_number_id)
    , title_input_element = document.getElementById(new_session_form_title_id)
    , synopsis_input_element = document.getElementById(new_session_form_synopsis_id);

    // create form for making new session card
    new_session_button.onclick = function() {
        form_container.classList.remove(hidden_class_name);
        new_session_button.classList.add(hidden_class_name);
    }

    // function to remove new session form and add the button back
    var cancel_new_session_func = function () {
        form_container.classList.add(hidden_class_name);
        new_session_button.classList.remove(hidden_class_name);
    }
    // remove form if cancel button is clicked
    cancel_button.onclick = function() {
        cancel_new_session_func();
    } 

    // capture and send new session to server
    new_session_form.addEventListener("submit", function() {
        // ensure that form is filled out correctly
        if (game_id_input_element.value != '' && number_input_element.value != '' && title_input_element.value != '' && parseInt(number_input_element.value) > -1) {
            if (!document.getElementById("session_card_"+number_input_element.value)) {
                socket.emit('send_new_session', game_id_input_element.value, number_input_element.value, title_input_element.value, synopsis_input_element.value);
                cancel_new_session_func();
                return false;
            } else {
                alert("Session number must be unique");
                return false;
            }
        } else {
            alert("Must fill out required fields");
            return false;
        }
    })
});
</script>
<div class="game-container">
    <div class="container">
        <h1>{{ game_name }}</h1>
        {% if dm_id == current_user.id %}
        <div class="new-session">
            <button class="button primary" id='new_session_button'>Start a new session?</button>
        </div>
{% endif %}
        <div class="notes-container">
            <div class="session-log">
                <h2>Session Log</h2>
            </div>
            <div class="notes">
                <h2>Notes</h2>
                <div class="comment-container">
                    <form id="test_form_quill">
                        <div class="form-group">
                        <div class="checkbox">
                            <input type='checkbox' class="note_checkbox" id='note_private' name='note_private' value='False'>
                            <label for='note_private'>Note is private(The GM will still be able to see it):</label>
                        </div>
                        <input name="about" type="hidden" style="z-index: 101;">
                        <input type="hidden" id='note_user_id' name='note_user_id' value='{{current_user.id}}'>
                        <input type="hidden" id='note_game_id' name='note_game_id' value='{{id}}'>
                        <div id="editor">
                        </div>
                        </div>
                        <div class="button-row">
                            <button class="button primary" type="submit">Submit</button>
                        </div>
                    </form>
                </div>
                <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
                <script>
                    var quill = new Quill('#editor', { 
                    modules: {
                        toolbar: [
                        ['bold', 'italic'],
                        [{ 'size': ['small', false, 'large', 'huge'] }],
                        [{ list: 'ordered' }, { list: 'bullet' }]
                        ]
                    },
                    placeholder: 'A note about this session.',
                    theme: 'snow'
                    });
                </script>
                <div id="Session Cards">
                    {% if session_titles %}
                    <!-- Session Title Cards -->
                    {% for session in session_titles %}
                    <div class="" id="session_header_{{session.id}}">
                        <h2>Session {{session.number}}: {{session.title}}</h2>
                        <div id="session_card_{{session.number}}">
                            <!-- Session Notes -->
                            <!-- Logic for if there is more than one session -->
                            {% if typ(note_dict[session.number]) == lis %}
                            <ul class="note_list" id="note_list_{{session.number}}">
                                {% for note in note_dict[session.number] %}
                                <li class="span_cont" id="note_line_{{note.id}}">
                                    <span class="span_cont" id='note_{{note.id}}'>
                                        {{ note.date_added }} || <b>{{ note.charname }}:</b>
                                        <span class="note_text" id='inner_{{note.id}}'>
                                        </span>
                                        {% if note.user_id == current_user.id %}
                                        <!-- Edit Button -->
                                        <a id='edit_{{note.id}}'>
                                            <img id='{{note.id}}' class='note_edit_button' src={{edit_img}}>
                                        </a>
                                        <form class='hidden edit_form' id="edit_form_{{ note.id }}">
                                            <input type='text' id="form_text_{{note.id}}" value='{{ note.note }}'>
                                            <input type='submit' value='submit'>
                                            <span class="checkbox_span">
                                                <input type='checkbox' class="" data-noteCheckbox="{{ note.private }}" value='{{ note.private }}'>
                                                <label for='change_private_{{note.id}}'>
                                                    Private?
                                                </label>
                                            </span>
                                            <span class="checkbox_span">
                                                <input type='checkbox' class="" data-noteCheckbox="{{ note.in_character }}" value='{{ note.in_character }}'>
                                                <label for='make_in_character_{{note.id}}'>
                                                    Change to <i>in character?</i>
                                                </label>
                                            </span>
                                        </form>
                                    </span>
                                    <!-- Edit Note Menu -->
                                    <nav id="note_edit_menu_{{note.id}}" class="note_edit_menu hidden">
                                        <ul class="note_edit_menu_items">
                                            <li class="note_edit_menu_item">
                                                <a href="#" id="note_edit_menu_edit_{{note.id}}" class="note_edit_menu_link" data-action="edit">
                                                    Edit Note
                                                </a>
                                            </li>
                                            <li class="note_edit_menu_item">
                                                <a href="#" id="note_edit_menu_delete_{{note.id}}" class="note_edit_menu_link" data-action="delete">
                                                    Delete Note
                                                </a>
                                            </li>
                                        </ul>
                                    </nav>
                                    {% endif %}
                                </li>
                                {% endfor %}
                            </ul>
                            <!-- Logic for if there is only one Session -->
                            {% else %}
                            <ul class="note_list" id="note_list_{{note_dict[session.number].number}}">
                                <li class="span_cont">
                                    <span class="spane_cont" id='note_{{note_dict[session.number].id}}'>
                                        {{ note_dict[session.number].date_added }} || <b>{{ note_dict[session.number].charname }}:</b>
                                        <span class="note_text" id='inner_{{note.id}}'>
                                        </span>
                                        {% if note.user_id == current_user.id %}
                                        <!-- Edit Button -->
                                        <a id='edit_note_{{note_dict[session.number].id}}'>
                                            <img id='{{note_dict[session.number].id}}' class='note_edit_button exclude' src={{edit_img}}>
                                        </a>
                                        <form class='hidden edit_form' id="edit_form_{{ note_dict[session.number].id }}">
                                            <input type='text' id="form_text_{{note_dict[session.number].id}}" value='{{ note_dict[session.number].note }}'>
                                            <input type='submit' value='submit'>
                                            <span class="checkbox_span"></span>
                                            <input type='checkbox' data-noteCheckbox="{{ note_dict[session.number].in_character }}" value='{{ note_dict[session.number].private }}'>
                                            <label for='change_private_{{note_dict[session.number].id}}'>
                                                Private?
                                            </label>
                                    </span>
                                    <span class="checkbox_span">
                                        <input type='checkbox' data-noteCheckbox="{{ note_dict[session.number].in_character }}" class="" value='{{ note_dict[session.number].in_character }}'>
                                        <label for='make_in_character_{{note_dict[session.number]}}'>
                                            Change to <i>in character?</i>
                                        </label>
                                    </span>
                                    </form>
                                    </span>
                                    <!-- Edit Note Menu -->
                                    <nav id="note_edit_menu_{{note_dict[session.number].id}}" class="note_edit_menu hidden">
                                        <ul class="note_edit_menu_items">
                                            <li class="note_edit_menu_item">
                                                <a href="#" id="note_edit_menu_edit_{{note_dict[session.number].id}}" class="note_edit_menu_link" data-action="edit">
                                                    Edit Note
                                                </a>
                                            </li>
                                            <li class="note_edit_menu_item">
                                                <a href="#" id="note_edit_menu_delete_{{note_dict[session.number].id}}" class="note_edit_menu_link" data-action="delete">
                                                    Delete Note
                                                </a>
                                            </li>
                                        </ul>
                                    </nav>
                                    {% endif %}
                                </li>
                            </ul>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% if dm_id == current_user.id %}
<div id="new_session_cont" class="hidden" style="z-index: 100;">
    <div class="modal-container">
        <div class="modal">
            <div class="content">
                <h2>Session Info</h2>
                <form id='new_session_form'>
                    <input id='new_session_form_game_id' type='hidden' value='{{id}}'>
                    <input id='new_session_form_number' required, placeholder='Number(Required)' type='number' min=0>
                    <input id='new_session_form_title' required, placeholder='Title(Required)' type='text'>
                    <input id='new_session_form_synopsis' type='text' , placeholder='Optional Synopsis'>
                    <input type='submit' value='Make Session'>
                    <input type='button' id='cancel_new_session' value='Cancel'>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}