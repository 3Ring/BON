{% extends "base.html" %}
{% block content %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA==" crossorigin="anonymous"></script>
<script type="text/javascript" charset="utf-8">
// Core variables
var user_id = {{current_user.id}}
, game_id = {{id}}
, js_dict = JSON.parse({{js_note_dict|tojson }});
</script>
<script src="{{ url_for('static', filename='js/notes/variables.js') }}"></script>
<script src="{{ url_for('static', filename='js/notes/general.js') }}"></script>
<script src="{{ url_for('static', filename='js/notes/socket_on.js') }}"></script>
<script src="{{ url_for('static', filename='js/notes/new_session.js') }}"></script>
<script src="{{ url_for('static', filename='js/notes/new_note.js') }}"></script>
<script src="{{ url_for('static', filename='js/notes/note_editor.js') }}"></script>
<script src="{{ url_for('static', filename='js/notes/main.js') }}"></script>
<script type="text/javascript" charset="utf-8">

document.addEventListener("DOMContentLoaded", function() {

    let note_session = 0;

    // set the current session in the loop
    {% for session in session_titles %}
    
    // loop through each session's notes and place in the correct location
    if (note_session == {{session.number}}) {} else { note_session = {{session.number}} }

    // insert note
    insert_rich_note(note_session);

    {% endfor %}
    
    {% if dm_id == current_user.id %}
    init("DM");
    {% else %}
    init();
    {% endif %}
})
</script>
<div class="game-container">
    <div class="container">
        <h1>{{ game_name }}</h1>
        {% if dm_id == current_user.id %}
            <div class="new-session">
                <button class="button primary" data-flag="button_newSessionDisplay">Start a new session?</button>
            </div>
        {% endif %}
        <div class="notes-container">
            {% if session_titles %}
            <div class="session-log">
                <h2>Session Log</h2>
                
                <ul class="sessions-list">
                    {% for session in session_titles %}
                    <li class="session-anchor" data-number_sessionList="{{ session.number }}">
                        <h4>Session {{ session.number }}</h4>
                        <h2>{{ session.title }}</h2>
                    </li>
                    {% endfor %}
                    <!-- <li class="session-anchor current">
                        <h4>Session 2</h4>
                        <h2>Into the Woods</h2>
                    </li>
                    <li class="session-anchor">
                        <h4>Session 1</h4>
                        <h2>The Thick Plottens</h2>
                    </li>
                    <li class="session-anchor">
                        <h4>Session 0</h4>
                        <h2>We are All Well Met</h2>
                    </li> -->
                </ul>
            </div>
            {% endif %}
            <div class="notes">
                <h2>Add a new note to this session.</h2>
                <div class="comment-container">
                    <form class="wysiwyg-form" data-flag="newQuill_FormSession" id="test_form_quill">
                        <div class="form-group">
                        <input type="hidden" id='note_user_id' name='note_user_id' value='{{current_user.id}}'>
                        <input type="hidden" id='note_game_id' name='note_game_id' value='{{id}}'>
                        <div id="Quill_sessionNew">
                        </div>
                        </div>
                        <div class="form-group">
                            <div class="row checkbox">
                                <input type='checkbox' class="note_checkbox" data-flag="newQuillPrivate" name='note_private' value='False'>
                                <label for='note_private'>Private - Visible only to you and the DM.</label>
                            </div>
                            <div class="row button-row">
                                <button class="button primary" type="submit">Submit</button>
                            </div>
                        </div>
                        
                    </form>
                </div>
                <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
                <script>
                    var quill = new Quill('#Quill_sessionNew', { 
                    modules: {
                        toolbar: [
                        ['bold', 'italic'],
                        [{ 'size': ['small', false, 'large', 'huge'] }],
                        [{ list: 'ordered' }, { list: 'bullet' }]
                        ]
                    },
                    placeholder: 'A note about this session.',
                    theme: 'snow'
                    });
                </script>
                <div class="sessions-scroll-container" data-flag="sessionsContainer" id="Session Cards">
                    {% if session_titles %}
                        <!-- Session Title Cards -->
                        {% for session in session_titles %}
                            <div class="session-container hidden" data-flag="session_cont" data-number_sessionCont="{{ session.number }}">
                                <h2>Session {{ session.number }}: {{ session.title }}</h2>
                                <div>
                                    <!-- Session Notes -->
                                    <ul class="note_list" data-idSession="{{ session.number }}">
                                        {% for note in note_dict[session.number] %}
                                        <li class="span_cont" data-id_noteCont="{{ note.id }}">
                                            <span class="span_cont note-item">
                                                <span class="note-author">
                                                    {% if note.charname == "DM" %}
                                                    <div class="author-image" style="background-image: url(../static/images/default_dm.jpg)"></div>
                                                    {% else %}
                                                    <div class="author-image" style="background-image: url(../static/images/default_character.jpg)"></div>
                                                    {% endif %}
                                                    <!-- {{ note.date_added }} || -->
                                                </span>

                                                <span class="note-content">
                                                    <h3>{{ note.charname }}:</h3>
                                                    <span class="note-ql" data-id_noteText="{{ note.id }}">
                                                    </span>
                                                </span>

                                                {% if note.user_id == current_user.id %}
                                                <!-- Edit Button -->
                                                <a data-editButtonAnchorId="{{ note.id }}" class="edit-note">
                                                    <span data-flag="editButtons" data-id_editImage="{{ note.id }}" class='note_edit_button far fa-edit' src="/static/images/edit_button_image.png"></span>
                                                </a>
                                                
                                                <form class="hidden wysiwyg-form" data-flag="formEdit" data-id_formEdit="{{ note.id }}">
                                                    <div class="form-group" >
                                                    
                                                        <input type="hidden" id='note_user_id' name='note_user_id' value='{{current_user.id}}'>
                                                        <input type="hidden" id='note_game_id' name='note_game_id' value='{{id}}'>
                                                        <div id="QuillEdit_{{ note.id }}" data-crumb="{{ note.id }}">
                                                        </div>
                                                    </div>
                                                    <div class="form-group">
                                                        <div class="row checkbox">
                                                            <input type='checkbox' class="note_checkbox" data-id_noteCheckboxPrivate="{{ note.id }}" name='note_private' value='False'>
                                                            <label for='note_private'>Private - Visible only to you and the DM.</label>
                                                        </div>
                                                        <div class="row button-row">
                                                            <button class="button primary" type="submit">Submit</button>
                                                        </div>
                                                    </div>
                                                </form>

                                                <!-- Edit Note Menu -->
                                                <div data-contextMenuId="{{ note.id }}" data-flag="contextMenu" class="note_edit_menu hidden">
                                                    <ul class="note_edit_menu_items">
                                                        <li class="note_edit_menu_item">
                                                            <a href="#" data-editMenuId="{{ note.id }}" class="note_edit_menu_link button secondary" data-id_note="{{ note.id }}" data-action="edit">
                                                                Edit Note
                                                            </a>
                                                        </li>
                                                        <li class="note_edit_menu_item">
                                                            <a href="#" data-editMenuId="{{ note.id }}" class="note_edit_menu_link button secondary" data-id_note="{{ note.id }}" data-action="delete">
                                                                Delete Note
                                                            </a>
                                                        </li>
                                                    </ul>
                                                </div>
                                                {% endif %}

                                            </span>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% if dm_id == current_user.id %}
<!-- New Session Form -->
<div data-flag="formNewSession_container" class="hidden" style="z-index: 100;">
    <!-- <div class="shroud"></div> -->
    <div class="modal-container">
        <div class="modal">
            <div class="content">
                <h2>Session Info</h2>
                <form data-flag="formNewSession_form">
                    <input data-flag="formNewSession_idGame" id='new_session_form_game_id' type='hidden' value='{{id}}'>
                    <input data-flag="formNewSession_inputSessionNumber" required placeholder='Number(Required)' type='number' min='0'>
                    <input data-flag="formNewSession_inputSessionTitle" required placeholder='Title(Required)' type='text'>
                    <input data-flag="formNewSession_inputSessionSynopsis" type='text' placeholder='Optional Synopsis'>
                    <input class="button primary" type='submit' value='Make Session'>
                    <input class="button secondary" type='button' data-flag="formNewSession_buttonCancel" value='Cancel'>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}