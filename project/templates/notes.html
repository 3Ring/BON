{% extends "base.html" %}
{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA==" crossorigin="anonymous"></script>
<script type="text/javascript" charset="utf-8">

const socket = io()



    document.addEventListener("DOMContentLoaded", function(event) { 
        const evt = new Event("NewSessionFormCreated", {"bubbles":true, "cancelable":false})
        var session_form_deployed = false
        var note_is_private = false
        var note_is_in_character = false

        // display new session card
        socket.on('fill_new_session', function(new_card) {
            session_cards = document.getElementById('Session Cards')
            session_cards.insertAdjacentHTML('afterbegin', new_card)
        });


        // display new note
        socket.on('fill_new_note', function(new_note, private, session_number, in_character) {
            this_session = document.getElementById('session_card_'+session_number)
            this_session.insertAdjacentHTML('afterbegin', new_note)
        });

        // set the values of the checkboxes based on whether they are checked or not
        document.getElementById('note_in_character').onclick = function () {
            if (note_is_in_character) {
                document.getElementById('note_in_character').value = 'n'
                note_is_in_character = false
            } else {
                document.getElementById('note_in_character').value = 'y'
                note_is_in_character = true
            }
        }
        document.getElementById('note_private').onclick = function () {
            if (note_is_private) {
                document.getElementById('note_private').value = 'n'
                note_is_private = false
            } else {
                document.getElementById('note_private').value = 'y'
                note_is_private = true
            }
        }
        




        {% if current_user.id == dmid %}
        // create form for making new session card
        document.getElementById("new_session_button").onclick = function() {
            // If new session form has already been deployed then pushing the button again will close it
            if (session_form_deployed) {
                document.getElementById("new_session_form_div").innerHTML = ""
                session_form_deployed = false
            } else {
                // Create and deploy new session form
                document.getElementById("new_session_form_div").innerHTML = "<h2>Session Info</h2><form id ='new_session_form'><input id='new_session_form_id' type='hidden' value='{{id}}'><input id='new_session_form_number' required, placeholder='Number(Required)' type='number' min=0><input id='new_session_form_title' required, placeholder='Title(Required)' type='text'><input id='new_session_form_synopsis' type='text', placeholder='Optional Synopsis'><input type='submit' value ='Make Session'></input><input type='button' id='cancel_new_session' value='Cancel'></input></form>"
                var new_session_form_id = document.getElementById('new_session_form_id')
                , new_session_form_number = document.getElementById('new_session_form_number')
                , new_session_form_title = document.getElementById('new_session_form_title')
                , new_session_form_synopsis = document.getElementById('new_session_form_synopsis')
                document.dispatchEvent(evt);
                session_form_deployed = true
            }
        }
        {% endif %}



        // capture and send new note to server
        document.getElementById("note_form").onsubmit = function() {
            var new_note_user_id = document.getElementById('note_user_id')
            , new_note_note = document.getElementById('note_note')
            , new_note_private = document.getElementById('note_private')
            , new_note_in_character = document.getElementById('note_in_character')
            , new_note_game_id = document.getElementById('note_game_id')

            socket.emit('send_new_note', new_note_user_id.value, new_note_game_id.value, new_note_note.value, new_note_private.value, new_note_in_character.value)
            return false
        }

    })
    // Create on sumbit function for new session card after form for it has been created
    document.addEventListener("NewSessionFormCreated", function(event) {
        // cancel button function
        document.getElementById("cancel_new_session").addEventListener("click", function() { 
            document.getElementById('new_session_form_div').innerHTML = ''
            session_form_deployed = false
        })
        // capture and send new session to server
        document.getElementById('new_session_form').onsubmit = function() {
            // ensure that form is filled out correctly
            if (new_session_form_id.value != '' && new_session_form_number.value != '' && new_session_form_title.value != '' && parseInt(new_session_form_number.value) > -1) {
                if (document.getElementById("session_card_"+new_session_form_number.value) == null) {
                    socket.emit('send_new_session', new_session_form_id.value, new_session_form_number.value, new_session_form_title.value, new_session_form_synopsis.value)
                    document.getElementById("new_session_form_div").innerHTML = ""
                    session_form_deployed = false
                    return false
                } else {
                    alert("Session number must be unique")
                    return false
                }
            } else {
                alert("Must fill out required fields")
                return false
            }
            
        }
    })


</script>

<form id="note_form">
    <input type=hidden id='note_user_id', name='note_user_id', value='{{current_user.id}}'>
    <input type=hidden id='note_game_id', name='note_game_id', value='{{id}}'>
    <label for='new_note_text'>Note:</label>
    <textarea id='note_note' required autocomplete='off' type='textarea' placeholder='Collaborative note'></textarea>
    <br/>
    <label for='note_private'>Note is private(The GM will still be able to see it):</label>
    <input type='checkbox' id='note_private', name='note_private', value='n'>
    <br/>
    <label for='note_in_characer'>Note is written in character:</label>
    <input type='checkbox' id='note_in_character', name='note_in_character', value='n'><br/>
    <input id='note_submit' type='submit' value='Submit' name='note_submit'>

</form>
<br/>
<br/>
{% if dmid == current_user.id %}
    
    <button id='new_session_button'>Start a new session?</button>
    <div id='new_session_form_div'></div>
{% endif %}

<div id="Session Cards">
{% if session_titles %}
    {% for session in session_titles %}
        <div class="border shadow-lg p-3 mb-5 bg-light rounded" id="session_header_{{session.id}}">
            <h2>Session {{session.number}}: {{session.title}}</h2>
            <div id="session_card_{{session.number}}">
                {% for note in logs[session.number] %}
                    <span id='note_span_{{note.id}}_{{note.user_id}}'>
                        <p id='note_{{note.id}}_{{note.user_id}}'>
                            {{ note.date_added }} || <b>{{ note.charname }}:</b> {{ note.note }}  
                            <a id='del_{{note.id}}_{{note.user_id}}'><img class='edit_button' src={{edit_img}}></a>
                        </p>
                    </span>

                {% endfor %}
            </div>
        </div>
    {% endfor %}
{% endif %}
</div>
{% endblock %}